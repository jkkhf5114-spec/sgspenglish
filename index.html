<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SGS Monitor Pro - Weekly Analysis</title>
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Cinzel:wght@700&family=Great+Vibes&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #1565C0; --danger: #D32F2F; --success: #2E7D32; --dark: #121212; --gold: #FFD700; --bg: #f4f7f6; --pink: #e91e63; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        html, body { height: 100%; margin: 0; background: var(--bg); font-family: 'Poppins', sans-serif; }
        .container { width: 100%; max-width: 480px; background: #fff; min-height: 100vh; display: flex; flex-direction: column; margin: auto; position: relative; }
        
        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.6s ease; }
        .header { background: var(--primary); color: white; padding: 15px; text-align: center; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; flex-shrink: 0; }
        .school-name { font-family: 'Cinzel', serif; font-weight: bold; color: var(--gold); font-size: 13px; }
        .screen { display: none; padding: 20px; flex-grow: 1; flex-direction: column; padding-bottom: 100px; }
        .active-screen { display: flex; }
        input, select, textarea { width: 100%; padding: 14px; margin: 8px 0; border-radius: 12px; border: 1px solid #ddd; text-align: center; font-family: inherit; }
        .btn-main { background: var(--dark); color: white; padding: 15px; border: none; border-radius: 50px; font-weight: bold; margin-top: 10px; cursor: pointer; width: 100%; }
        .student-item { background: #fff; border: 1px solid #eee; padding: 12px; margin-bottom: 10px; border-radius: 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .att-dot { width: 35px; height: 35px; border-radius: 50%; border: none; color: white; font-weight: bold; cursor: pointer; }
        .p-bg { background: var(--success); } .a-bg { background: var(--danger); }
        .score-val { font-size: 50px; font-weight: 800; color: var(--primary); text-align: center; margin: 5px 0; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .act-btn { border: none; border-radius: 15px; color: white; font-weight: bold; height: 75px; font-size: 13px; cursor: pointer; }

        /* --- NEW PROFESSIONAL CERTIFICATE STYLING --- */
        #cert-wrapper { position: absolute; left: -9999px; top: 0; }
        .certificate { width: 800px; height: 600px; background: #fff; padding: 30px; text-align: center; position: relative; border: 15px solid var(--primary); border-image: linear-gradient(to right, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c) 5; }
        .cert-inner { border: 2px solid #b38728; height: 100%; padding: 20px; background: radial-gradient(circle, #fff 60%, #f9f9f9); }
        .cert-school { font-family: 'Cinzel', serif; color: var(--primary); font-size: 32px; margin-bottom: 5px; font-weight: 700; }
        .cert-title { font-family: 'Great Vibes', cursive; color: #b38728; font-size: 45px; margin: 10px 0; }
        .cert-msg { font-size: 16px; color: #444; margin-bottom: 30px; font-style: italic; line-height: 1.4; }
        .rank-container { display: flex; justify-content: center; align-items: flex-end; gap: 20px; margin-top: 20px; }
        .rank-box { padding: 15px; border-radius: 15px; border: 2px solid #eee; width: 180px; background: white; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .rank-box.gold { transform: scale(1.15); border-color: #ffd700; background: linear-gradient(145deg, #fffdf0, #fff9c4); z-index: 2; border-width: 3px; }
        .rank-num { font-weight: bold; font-size: 14px; margin-bottom: 5px; color: #666; }
        .gold .rank-num { color: #b38728; font-size: 18px; }
        .rank-name { font-weight: 700; font-size: 20px; color: #333; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .cert-footer { margin-top: 50px; display: flex; justify-content: space-between; align-items: center; padding: 0 40px; }
        .sign-box { border-top: 1px solid #333; width: 150px; font-size: 12px; padding-top: 5px; }

        /* DIARY & MARKS */
        .tab-group { display: flex; background: #eee; padding: 5px; border-radius: 25px; margin-bottom: 15px; }
        .tab-btn { flex: 1; border: none; background: transparent; padding: 10px; border-radius: 20px; font-weight: bold; color: #666; cursor: pointer; }
        .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .marks-input { width: 60px; padding: 8px; border: 2px solid #ddd; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <div id="splash-screen">
        <img src="logo.png" onerror="this.src='https://via.placeholder.com/150?text=SGS+LOGO'" style="width:160px; height:160px; border-radius:50%; border:4px solid var(--pink); margin-bottom:20px;">
        <div style="font-family:'Cinzel'; color:var(--primary); font-weight:bold; font-size:18px; text-align:center;">SHRI GAYATRI SANSKAAR<br>PUBLIC SCHOOL</div>
        <div style="margin-top:20px; font-size:10px; color:#999;">Tech By Ashish Sir</div>
    </div>

    <div class="header">
        <div style="font-size:10px; color:#fff; margin-bottom:5px;">Tech By Ashish Sir</div>
        <div class="school-name">SHRI GAYATRI SANSKAAR PUBLIC SCHOOL</div>
    </div>

    <div id="screen-login" class="screen active-screen" style="justify-content:center;">
        <div id="adminNoticeDisplay" style="background:#FFF9C4; color:#5D4037; padding:15px; border-radius:15px; font-size:14px; margin-bottom:20px; border:1px dashed #FBC02D; display:none; text-align: center;"></div>
        <h4 style="text-align:center; color:var(--primary);">Teacher Login</h4>
        <input type="text" id="tName" placeholder="Teacher Name">
        <input type="text" id="tClass" placeholder="Class (e.g. 5th, Sainik)">
        <input type="password" id="tPin" placeholder="Security PIN">
        <button class="btn-main" onclick="teacherLogin()">LOGIN TO CLASS</button>
    </div>

    <div id="screen-dashboard" class="screen">
        <button class="btn-main" style="background:var(--danger); border:2px solid #fff;" onclick="generateAttendanceReport('emergency')">üõ°Ô∏è SAFETY ATTENDANCE ALERT</button>
        <div style="display:flex; justify-content:space-between; align-items:center; margin:15px 0;">
            <h4 style="margin:0;">Class: <span id="dashClassName" style="color:var(--primary)">--</span></h4>
            <button onclick="location.reload()" style="background:#ddd; border:none; padding:5px 10px; border-radius:10px;">Logout</button>
        </div>
        <button class="btn-main" style="background: linear-gradient(45deg, #6200EA, #9C27B0);" onclick="openDiary()">üìù DIARY & EXAM MARKS</button>
        <button class="btn-main" style="background:var(--primary); margin:10px 0;" onclick="addNewStudent()">‚ûï Add New Student</button>
        <div id="studentListContainer"></div>
        <button class="btn-main" style="background:#E65100; margin-top:20px;" onclick="generateWeeklyProfessionalReport()">üìä WEEKLY PERFORMANCE REPORT</button>
        <button class="btn-main" style="background:#00897B; margin-top:10px;" onclick="generateAttendanceReport('normal')">üìã ATTENDANCE REPORT</button>
        <button class="btn-main" style="background:var(--gold); color: #000; margin-top:10px;" onclick="downloadWeeklyCertificate()">üñºÔ∏è DOWNLOAD WEEKLY CERTIFICATE</button>
    </div>

    <div id="screen-tracker" class="screen">
        <button onclick="backToDashboard()" style="width:90px; background:#444; color:white; border:none; padding:10px; border-radius:15px; margin-bottom:10px;">‚¨Ö Back</button>
        <div id="dispName" style="text-align:center; font-weight:bold; font-size:22px; color:var(--primary);">--</div>
        <div class="score-val" id="scoreVal">...</div>
        <h5 style="color:var(--danger); margin:10px 0;">üö´ Bad Behaviors</h5>
        <div class="grid">
            <button class="act-btn" style="background:#EF5350;" onclick="updateScore(-5, 'Talking')">üó£Ô∏è Talking</button>
            <button class="act-btn" style="background:#EF5350;" onclick="updateScore(-5, 'No Homework')">üìö No HW</button>
            <button class="act-btn" style="background:#D32F2F;" onclick="updateScore(-15, 'Fighting')">üëä Fighting</button>
            <button class="act-btn" style="background:#EF5350;" onclick="updateScore(-5, 'Abuse')">üòà Abuse</button>
        </div>
        <h5 style="color:var(--success); margin:15px 0 10px 0;">‚úÖ Good Behaviors</h5>
        <div class="grid">
            <button class="act-btn" style="background:#66BB6A;" onclick="updateScore(5, 'Best Ans')">üôã Best Ans</button>
            <button class="act-btn" style="background:#66BB6A;" onclick="updateScore(5, 'Helping')">ü§ù Helping</button>
            <button class="act-btn" style="background:#66BB6A;" onclick="updateScore(5, 'Silence')">ü§´ Silence</button>
            <button class="act-btn" style="background:#66BB6A;" onclick="updateScore(5, 'Super Work')">üåü Super</button>
        </div>
        <div id="logArea" style="margin-top:15px; background:#f9f9f9; padding:10px; border-radius:10px; height:100px; overflow-y:auto; font-size:11px;"></div>
    </div>

    <div id="screen-diary" class="screen">
        <button onclick="backToDashboardFromDiary()" style="width:80px; background:#ddd; border:none; padding:8px; border-radius:20px; margin-bottom:15px;">‚¨Ö Back</button>
        <div class="tab-group">
            <button class="tab-btn active" onclick="switchDiaryTab('hw')" id="btn-hw">Homework</button>
            <button class="tab-btn" onclick="switchDiaryTab('test')" id="btn-test">Tests</button>
        </div>
        <div id="tab-hw-content">
            <textarea id="hwText" rows="4" placeholder="Enter Diary..."></textarea>
            <button class="btn-main" style="background:#E65100;" onclick="sendDiaryWhatsApp()">üì§ SEND DIARY</button>
        </div>
        <div id="tab-test-content" style="display:none;">
            <input type="text" id="testName" placeholder="Test Name">
            <input type="number" id="totalMarks" placeholder="Total Marks">
            <div id="marksList"></div>
            <button class="btn-main" style="background:var(--success);" onclick="saveTestResult()">üíæ SAVE MARKS</button>
            <button class="btn-main" style="background:var(--primary);" onclick="shareMarksWhatsApp()">üì§ SHARE MARKS ON WHATSAPP</button>
        </div>
    </div>
</div>

<div id="cert-wrapper">
    <div id="capture-area" class="certificate">
        <div class="cert-inner">
            <div class="cert-school">SHRI GAYATRI SANSKAAR PUBLIC SCHOOL</div>
            <div style="font-size: 12px; letter-spacing: 2px; color: #666; text-transform: uppercase;">Weekly Excellence Recognition</div>
            <div class="cert-title">Stars of the Week</div>
            <div class="cert-msg">
                We are extremely proud to announce the top performers of <b>Class <span id="cert-cls"></span></b>.<br>
                Your hard work, discipline, and consistent performance have set a great example!
            </div>
            
            <div class="rank-container">
                <div class="rank-box">
                    <div class="rank-num">ü•à RANK 2</div>
                    <div class="rank-name" id="cert-r2">---</div>
                </div>
                <div class="rank-box gold">
                    <div class="rank-num">ü•á TOPPER</div>
                    <div class="rank-name" id="cert-r1">---</div>
                </div>
                <div class="rank-box">
                    <div class="rank-num">ü•â RANK 3</div>
                    <div class="rank-name" id="cert-r3">---</div>
                </div>
            </div>

            <div class="cert-footer">
                <div style="font-size: 10px; color: #999;">Date: <span id="cert-date"></span></div>
                <div class="sign-box">Principal Signature</div>
                <div style="font-size: 10px; color: #999;">Tech By Ashish Sir</div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, push, get } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA43-vMdUK3jtsTOzwHhe8QDjJzatpekgM",
        authDomain: "schoolmonitor-6aa3d.firebaseapp.com",
        databaseURL: "https://schoolmonitor-6aa3d-default-rtdb.firebaseio.com",
        projectId: "schoolmonitor-6aa3d",
        storageBucket: "schoolmonitor-6aa3d.firebasestorage.app",
        messagingSenderId: "303795138626",
        appId: "1:303795138626:web:2317ab227f81ce32d2bddb"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let teacher = "", cls = "", curID = "", curData = {};

    window.onload = () => { setTimeout(() => { document.getElementById('splash-screen').style.display='none'; }, 2000); };
    onValue(ref(db, 'admin_settings/notice'), (snap) => { if(snap.exists()){ const m=document.getElementById('adminNoticeDisplay'); m.innerText=snap.val(); m.style.display="block";} });

    window.teacherLogin = () => {
        get(ref(db, 'admin_settings/teacher_pin')).then(s => {
            if(document.getElementById('tPin').value !== String(s.val()||"5114")) return alert("Wrong PIN");
            teacher = document.getElementById('tName').value;
            cls = document.getElementById('tClass').value.trim();
            document.getElementById('screen-login').classList.remove('active-screen');
            document.getElementById('screen-dashboard').classList.add('active-screen');
            document.getElementById('dashClassName').innerText = cls.toUpperCase();
            loadStudents();
        });
    };

    function loadStudents() {
        onValue(ref(db, 'students'), (snap) => {
            const cont = document.getElementById('studentListContainer');
            cont.innerHTML = ""; let search = cls.toLowerCase().replace(/\s/g, '');
            const data = snap.val();
            for(let id in data) {
                if(data[id].class && data[id].class.toLowerCase().replace(/\s/g, '') === search) {
                    let att = data[id].att || 'P';
                    cont.innerHTML += `<div class="student-item"><div onclick="openTracker('${id}', '${data[id].name}')" style="flex-grow:1;"><b>${data[id].name}</b><br><small>Points: ${data[id].score}</small></div><button class="att-dot ${att=='P'?'p-bg':'a-bg'}" onclick="toggleAtt('${id}','${att}')">${att}</button></div>`;
                }
            }
        });
    }

    window.updateScore = (p, r) => {
        let ns = Math.max(0, Math.min(100, (curData.score || 100) + p));
        update(ref(db, 'students/'+curID), {score: ns});
        push(ref(db, 'weekly_analysis/'+curID), { r: r, p: p, date: new Date().toLocaleDateString() });
    };

    // Professional Weekly WhatsApp Report (Mon-Sat)
    window.generateWeeklyProfessionalReport = async function() {
        const snap = await get(ref(db, 'students'));
        const weeklyLogs = await get(ref(db, 'weekly_analysis'));
        const weeklyTests = await get(ref(db, 'weekly_tests'));
        
        if(!snap.exists()) return alert("No Data Found");
        let data = snap.val(), logs = weeklyLogs.val()||{}, tests = weeklyTests.val()||{};
        let search = cls.toLowerCase().replace(/\s/g, '');
        let reportData = [];

        for(let id in data) {
            if(data[id].class && data[id].class.toLowerCase().replace(/\s/g, '') === search) {
                let sLogs = logs[id] ? Object.values(logs[id]) : [];
                let sTests = tests[id] ? Object.values(tests[id]) : [];
                let bad = { Talking:0, "No Homework":0, Fighting:0, Abuse:0 };
                let good = { "Best Ans":0, Helping:0, Silence:0, "Super Work":0 };
                sLogs.forEach(l => {
                    if(l.p < 0) bad[l.r] = (bad[l.r] || 0) + Math.abs(l.p);
                    else good[l.r] = (good[l.r] || 0) + l.p;
                });
                let tAvg = 0;
                if(sTests.length > 0) tAvg = sTests.reduce((a,b)=>a+(b.m/b.t)*100, 0)/sTests.length;
                reportData.push({ name: data[id].name, score: data[id].score, bad, good, tAvg: tAvg.toFixed(0) });
            }
        }

        reportData.sort((a,b) => b.score - a.score);

        let msg = `*üè´ SHRI GAYATRI SANSKAAR PUBLIC SCHOOL*\n*üìä WEEKLY PERFORMANCE REPORT*\n\n‡§®‡§Æ‡§∏‡•ç‡§§‡•á ‡§Ö‡§≠‡§ø‡§≠‡§æ‡§µ‡§ï‡•ã‡§Ç, ‡§Ø‡§π ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§Ü‡§™‡§ï‡•á ‡§¨‡§ö‡•ç‡§ö‡•á ‡§ï‡•á ‡§™‡•Ç‡§∞‡•á ‡§∏‡§™‡•ç‡§§‡§æ‡§π ‡§ï‡•á ‡§µ‡•ç‡§Ø‡§µ‡§π‡§æ‡§∞ ‡§î‡§∞ ‡§™‡•ù‡§æ‡§à ‡§ï‡§æ ‡§Ü‡§à‡§®‡§æ ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§¶‡•á‡§ñ‡•á‡§Ç ‡§ï‡§ø ‡§¨‡§ö‡•ç‡§ö‡•á ‡§®‡•á ‡§ï‡§π‡§æ‡§Å ‡§∏‡•Å‡§ß‡§æ‡§∞ ‡§ï‡§ø‡§Ø‡§æ ‡§π‡•à ‡§î‡§∞ ‡§ï‡§π‡§æ‡§Å ‡§î‡§∞ ‡§Æ‡•á‡§π‡§®‡§§ ‡§ï‡•Ä ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï‡§§‡§æ ‡§π‡•à‡•§ üôè\n\n*Class:* ${cls}\n--------------------------\n`;
        reportData.forEach((s, i) => {
            let rank = (i === 0) ? "ü•á " : (i === 1) ? "ü•à " : (i === 2) ? "ü•â " : `${i+1}. `;
            msg += `${rank}*${s.name.toUpperCase()}*\nüö´ *Bad Habits:* Talk:${s.bad.Talking}%, HW:${s.bad["No Homework"]}%, Fight:${s.bad.Fighting}%\n‚úÖ *Good Habits:* Ans:${s.good["Best Ans"]}%, Help:${s.good.Helping}%, Silence:${s.good.Silence}%\nüìù *Test Perf:* ${s.tAvg}%\n‚≠ê *Final Points:* ${s.score}/100\n--------------------------\n`;
        });
        msg += `\n_Tech By Ashish Sir & Group_`;
        window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`);
    };

    // New Function: Share Marks on WhatsApp with Ranking
    window.shareMarksWhatsApp = async function() {
        const testName = document.getElementById('testName').value;
        const totalMarks = document.getElementById('totalMarks').value;
        const inputs = document.querySelectorAll('.marks-input');

        if(!testName || !totalMarks) return alert("Please enter Test Name and Total Marks first!");

        let marksData = [];
        const snap = await get(ref(db, 'students'));
        const students = snap.val();

        inputs.forEach(inp => {
            const sid = inp.id.substring(5);
            const val = inp.value;
            if(val !== "" && students[sid]) {
                marksData.push({
                    name: students[sid].name,
                    obtained: parseFloat(val)
                });
            }
        });

        if(marksData.length === 0) return alert("No marks entered to share!");

        // Sort by marks (Descending)
        marksData.sort((a, b) => b.obtained - a.obtained);

        let msg = `*üè´ SHRI GAYATRI SANSKAAR PUBLIC SCHOOL*\n*üìù TEST RESULT REPORT*\n\n*Subject/Test:* ${testName}\n*Total Marks:* ${totalMarks}\n*Class:* ${cls}\n--------------------------\n`;
        
        marksData.forEach((s, i) => {
            let medal = (i === 0) ? "ü•á " : (i === 1) ? "ü•à " : (i === 2) ? "ü•â " : `${i+1}. `;
            msg += `${medal}*${s.name.toUpperCase()}*\nMarks: ${s.obtained}/${totalMarks}\n--------------------------\n`;
        });

        msg += `\n_Tech By Ashish Sir_`;
        window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`);
    };

    // Certificate Download Logic
    window.downloadWeeklyCertificate = async function() {
        const snap = await get(ref(db, 'students'));
        if(!snap.exists()) return;
        let search = cls.toLowerCase().replace(/\s/g, '');
        let students = Object.values(snap.val()).filter(s => s.class && s.class.toLowerCase().replace(/\s/g, '') === search);
        students.sort((a,b) => b.score - a.score);

        document.getElementById('cert-cls').innerText = cls.toUpperCase();
        document.getElementById('cert-r1').innerText = students[0] ? students[0].name : "---";
        document.getElementById('cert-r2').innerText = students[1] ? students[1].name : "---";
        document.getElementById('cert-r3').innerText = students[2] ? students[2].name : "---";
        document.getElementById('cert-date').innerText = new Date().toLocaleDateString();

        html2canvas(document.querySelector("#capture-area"), { scale: 2 }).then(canvas => {
            let link = document.createElement('a');
            link.download = `SGS_Stars_${cls}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
        });
    };

    // Marks saving
    window.saveTestResult = () => {
        const test = document.getElementById('testName').value;
        const total = document.getElementById('totalMarks').value;
        const inputs = document.querySelectorAll('.marks-input');
        if(!test || !total) return alert("Enter Test Name & Total");
        inputs.forEach(inp => {
            const sid = inp.id.substring(5);
            if(inp.value !== "") push(ref(db, 'weekly_tests/'+sid), { n: test, m: parseFloat(inp.value), t: parseFloat(total) });
        });
        alert("Tests Saved!");
    };

    // Standard Utils
    window.toggleAtt = (id, cur) => { update(ref(db, 'students/'+id), {att: cur=='P'?'A':'P'}); };
    window.openTracker = (id, name) => { curID = id; document.getElementById('screen-dashboard').classList.remove('active-screen'); document.getElementById('screen-tracker').classList.add('active-screen'); document.getElementById('dispName').innerText = name; onValue(ref(db, 'students/'+id), s => { curData = s.val(); document.getElementById('scoreVal').innerText = curData.score; }); };
    window.backToDashboard = () => { document.getElementById('screen-tracker').classList.remove('active-screen'); document.getElementById('screen-dashboard').classList.add('active-screen'); };
    window.addNewStudent = () => { let n = prompt("Name:"); if(n) set(ref(db, 'students/'+n.toLowerCase().replace(/\s/g,'')), {name:n, class:cls, score:100, att:'P'}); };
    window.openDiary = () => { document.getElementById('screen-dashboard').classList.remove('active-screen'); document.getElementById('screen-diary').classList.add('active-screen'); loadMarksList(); };
    window.backToDashboardFromDiary = () => { document.getElementById('screen-diary').classList.remove('active-screen'); document.getElementById('screen-dashboard').classList.add('active-screen'); };
    window.switchDiaryTab = (t) => { document.getElementById('tab-hw-content').style.display = t=='hw'?'block':'none'; document.getElementById('tab-test-content').style.display = t=='test'?'block':'none'; };
    window.sendDiaryWhatsApp = () => { window.open(`https://wa.me/?text=${encodeURIComponent("*SGS DIARY*\n"+document.getElementById('hwText').value)}`); };

    function loadMarksList() {
        onValue(ref(db, 'students'), (snap) => {
            const list = document.getElementById('marksList'); list.innerHTML = "";
            let search = cls.toLowerCase().replace(/\s/g, '');
            for(let id in snap.val()) if(snap.val()[id].class.toLowerCase().replace(/\s/g,'') === search)
            list.innerHTML += `<div>${snap.val()[id].name}: <input type="number" class="marks-input" id="mark-${id}"></div>`;
        });
    }

    window.generateAttendanceReport = (type) => {
        get(ref(db, 'students')).then(s => {
            let abs = []; Object.values(s.val()).forEach(v => { if(v.att==='A') abs.push(v.name); });
            let m = type==='emergency' ? `*SAFETY ALERT* Absent: ${abs.join(',')}` : `*ATTENDANCE REPORT*`;
            window.open(`https://wa.me/?text=${encodeURIComponent(m)}`);
        });
    };
</script>
</body>
</html>